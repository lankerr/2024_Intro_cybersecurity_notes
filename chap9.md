# DNS安全
攻击面	攻击类型	共性特征	DNS缺陷	防御策略
本地DNS
服务器	缓存中毒攻击	①攻击者利用嗅探或推测等方式伪造DNS应答，欺骗服务器采信
②攻击者利用域名系统存在的复杂解析依赖，寻找解析环节配置错误，发起攻击
③攻击者大量消耗系统资源	①协议设计缺乏验证及加密机制
②系统缺乏严格管理机制
③服务器缺乏分布式部署等保护措施	①建立支持验证及加密能力的基础设施
②健全域名系统管理机制
③部署服务器保护措施
互联网DNS
服务器	来自恶意DNS服务器的回复伪造攻击
本地/互联网DNS服务器	拒绝服务攻击

# DNS的演进
注意，人类记忆的叫做域名，计算机记忆的叫做IP地址。DNS就是将域名转换为IP地址的服务。
1983年以前，互联网上的每台计算机都有一个静态的主机文件，里面记录了域名和IP地址的对应关系。这种方式不适合互联网的快速发展，因此诞生了DNS。
1983年，Paul Mockapetris设计了DNS，将域名和IP地址的对应关系存储在分布式数据库中，这样就可以动态地添加、删除和修改域名和IP地址的对应关系。
DNS的工作原理：DNS服务器将域名解析为IP地址，然后将IP地址返回给客户端。
域名系统采用层级树形结构，最顶层为根(Root)，根下面是顶级域名(Top-Level Domain, TLD)，TLD下面是二级域名(Second-Level Domain)，二级域名下面是三级域名(Third-Level Domain)，以此类推。

# DNS使用及解析过程
1.  浏览器输入域名
2.  请求到达DNS解析程序
3.  查询获得IP地址
4. 返回IP至Web浏览器
5. 访问IP地址
6. 浏览器显示该页面

DNS攻击:
1. 缓存中毒攻击
缓存中毒是指利用本地DNS服务器的缓存机制，将被篡改的虚假信息缓存到本地DNS 服务器，达到持续造成危害的目的
只针对回复部分伪造，影响面一个主机名
针对本地DNS服务器的DNS服务请求，攻击者使用伪造源地址发送伪造回复，在伪造回复中，把主机名www.example.com映射到攻击地址，并且告诉本地DNS服务器www.example.com的域名服务器是攻击者的计算机
针对授权部分攻击，影响面：整个域
将ns.attack.com放在授权部分，该记录被本地DNS服务器放入缓存后，当查询目标域内任何一个主机名时，本地服务器会把请求发给ns.attack.com，由于本地DNS服务器并不知道ns.attack.com的IP地址，因此先发送一个DNS请求查询地址。因此在实际的攻击中，需要为购买域名，为ns.attack.com注册一个真正的IP地址
我们甚至只需要假装一下就可以:
可以使用scapy以下是代码:
```python
from scapy.all import *
 
def spoof_ns(pkt):
  if(DNS in pkt ):
    IPpacket = IP(dst=pkt[IP].src,src=pkt[IP].dst)
    UDPpacket = UDP(dport=pkt[UDP].sport,sport=53)
    Ans = DNSRR(rrname=pkt[DNS].qd.qname,type='A',rdata='108.109.10.66',
ttl=172800)
    DNSpacket = DNS(id=pkt[DNS].id, qd=pkt[DNS].qd, aa=1, rd=0,qdcount=1,
    qr=1,ancount=1,nscount=0, an=Ans)
    spoofpacket=IPpacket/UDPpacket/DNSpacket
    send(spoofpacket)
    spoofpacket.show()
 
pkt=sniff(filter='udp and (src host 10.0.10.5  and dst port 53)',prn= spoof_ns)
```
难点:
由于不能嗅探DNS请求，因为DNS请求是UDP协议，而UDP协议是无连接的，因此不能嗅探，所以我们只能通过其他方式来获取DNS请求，比如ARP欺骗，但是这样会有一定的风险
我们需要了解一下嗅探器的机理:嗅探器是对面向链接的协议可以进行嗅探，而对于无连接的协议，我们只能通过其他方式来获取数据包，比如ARP欺骗，但是我们DNS中毒需要两个数据一个是UDP的16位ID，一个是UDP的源端口号

我们成功的攻击就是1。出发DNS服务器产生请求 2.发送欺骗回复 3.使缓存失效
我们需要注意以下我们的包头:
![image](/image/UDP_attack.png)
看上去数据很大，但是在实际上不难？
第八章在协议栈中已经讲过利用数据包分片发动的攻击，Brandt 等人利用 UDP 数据包分片重组技术，实现了一种旁路注入攻击[9]。互联网连接不同的网络，每段网络的最大传输单元（Maximum Transmission Unit，MTU）不一定相同。当应答报文超出某段网络MTU时会被中间路由器强制分片，并在递归解析服务器上重组。攻击者提前向递归解析服务器注入虚假 DNS 响应分片，利用数据包重组过程篡改重组后的域名解析结果，同样能够实现缓存攻击。
我们可以使用侧信道攻击，可以先测出端口号，这样子是我们攻击成功几率进一步变大
# 拒绝服务攻击

# 攻击根服务器—难以成功

# 攻击顶级服务器—巨大威胁
2013年8月25日凌晨，.CN域名凌晨出现大范围解析故障，导致大面积.CN域名无法解析，直到当日凌晨4点左右，CN根域名服务器解析才开始部分恢复

# 攻击特定域名服务器—影响深远

然后我们需要看看DNS的防御策略:

## 通过非对称加密验证身份—DNSSEC
DNSSEC在兼容现有协议基础上引入公钥加密/认证体系，通过签名提供端到端的数据真实性和完整性保护。主要功能包括：密钥分发；数据完整性和原始性认证；事务和请求认证
签名过程原理

在域名服务器收到域名注册数据后，用散列函数将要回复 DNS 报文的内容进行散列运算， 得到 “内容摘要”，然后使用私钥对其加密，并将加密后的信息附加到DNS 报文中

验证过程原理

递归服务器收到 DNSSEC 报文，利用散列函数计算报文 “内容摘要”，利用公钥解密收到加密 “内容摘要”。 对比 “摘要”内容，相同则确认收到的 数据正确

- 信任锚
但是注意：这种状态下，这台权威服务器可能是假冒的，递归服务器请求这台假冒的权威服务器，那么对于解析结果的正确性和完整性的验证上认为是正确的，但其实这个解析结果是假冒的，怎么发现？DNSSEC需要一条信任链，即必须要有一个或者多个相信的公钥，这些公钥被称为信任锚。

当然也存在许多问题
1) 效率问题。大量签名和验证带来严重的负载
2) 密钥系统管理问题。离线存储密钥与频繁使用密钥存在矛盾，假定私钥不被窃取违反了安全管理和域名服务器管理角色分离的原则
3) 只提供数据原始性验证和完整性检查，没有提供机密性和一致性检验，无法抵御重放攻击
4) 只提供单向认证，没有对客户的认证，不能解决缓存中毒
5) 没有提供DoS防护
6) 增加了新的实现错误和配置错误机会，如攻击者能够轻易遍历区域文件中全部子域名
7) 花费较高，经济因素制约其部署
8) 最终仍然取决于递归服务器以及客户端是否对数字签名记录做校验

# 基于系统管理
附加区记录和问题区问题不在同一域管辖，则不会采信，防范恶意权威DNS虚假记录污染缓存
比如，请求www.foo.com时，应答包里出现关于www.bar.com的记录，根据bailiwick检查规则，不会接受此A记录
这个是严格的检查，但是也有问题，比如有些域名是有多个权威DNS服务器的，这样就会出现问题，所以这个方法并不是很好

# 新型架构设计-Blockstack

我们的攻击也层出不穷
攻击一: Kaminsky攻击
恶意人员随机查询请求到的DNS服务器，再权威应答之前伪造应答包发送给服务器，修改授权人员资源记录
比如我们攻击者向Apollo询问一个随机产生的域名，Apollo会向权威服务器询问，猜测端口号和ID，具体原理是如果攻击者猜测的ID和端口号和Apollo的ID和端口号一致，侧信道就会有反馈，如果猜对了，我们就可以进行攻击
优点在于主动访问不存在的域名，没有TTL限制，攻击成功率高
攻击二：恶意服务器回复伪造攻击
我们可以利用DNS服务器的漏洞来控制特定权威的服务器，篡改权威服务器的记录，这样就可以进行攻击
